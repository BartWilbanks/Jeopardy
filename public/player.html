<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Player — Jeopardy Live</title>
  <style>
    body{font-family:system-ui;margin:0;padding:18px;max-width:720px}
    input,select,button{font-size:16px;padding:10px;border-radius:10px;border:1px solid #ccc}
    button{cursor:pointer}
    .card{border:1px solid #ddd;border-radius:12px;padding:14px;margin-top:12px}
    .big{font-size:22px;font-weight:900;line-height:1.2;white-space:pre-wrap}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid #ddd;color:#444;font-size:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    #buzz{width:100%;padding:18px;font-size:22px;font-weight:900}
    .gold{color:#b98500}
  </style>
</head>
<body>
  <h1>Join Game</h1>

  <div class="card">
    <input id="code" placeholder="Room Code (e.g. A7K3Q)" style="width:100%;text-transform:uppercase" />
    <input id="name" placeholder="Your Name" style="width:100%;margin-top:8px" />
    <select id="team" style="width:100%;margin-top:8px">
      <option value="0">Team 1</option>
      <option value="1">Team 2</option>
      <option value="2">Team 3</option>
    </select>
    <button id="join" style="width:100%;margin-top:10px">Join</button>
  </div>

  <div class="card" id="status">Not connected.</div>

  <div class="card" id="view" style="display:none">
    <div class="row" style="justify-content:space-between">
      <span class="pill" id="modePill">Mode: —</span>
      <span class="pill" id="turnPill" style="display:none">Turn: —</span>
      <span class="pill" id="buzzPill" style="display:none">Buzz: —</span>
    </div>
    <div class="big" id="active" style="margin-top:10px"></div>
    <button id="buzz" style="display:none;margin-top:12px">BUZZ!</button>
    <div id="hint" style="margin-top:10px;color:#666;"></div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const ioClient = io();
    let currentCode = null;
    let lastState = null;

    const status = document.getElementById("status");
    const view = document.getElementById("view");
    const active = document.getElementById("active");
    const buzzBtn = document.getElementById("buzz");
    const modePill = document.getElementById("modePill");
    const turnPill = document.getElementById("turnPill");
    const buzzPill = document.getElementById("buzzPill");
    const hint = document.getElementById("hint");

    document.getElementById("join").onclick = () => {
      const code = document.getElementById("code").value.trim().toUpperCase();
      const name = document.getElementById("name").value.trim();
      const teamIndex = parseInt(document.getElementById("team").value, 10);
      ioClient.emit("player:join", { code, playerName: name, teamIndex });
    };

    buzzBtn.onclick = () => {
      if(!currentCode) return;
      ioClient.emit("player:buzz", { code: currentCode });
    };

    ioClient.on("room:error", ({ message }) => {
      status.textContent = message;
    });

    ioClient.on("player:joined", ({ code, state }) => {
      currentCode = code;
      status.textContent = `Joined room ${code}. Waiting for questions…`;
      render(state);
    });

    ioClient.on("room:update", ({ state }) => {
      render(state);
    });

    ioClient.on("room:ended", () => {
      alert("Host ended the game.");
      location.reload();
    });

    function render(state){
      lastState = state;

      // Update team names in dropdown
      const sel = document.getElementById("team");
      const old = sel.value;
      sel.innerHTML = state.teams.map((t,i)=>`<option value="${i}">${t.name}</option>`).join("");
      sel.value = old;

      view.style.display = "block";
      modePill.textContent = `Mode: ${state.mode}`;

      if(state.mode === "TURNS"){
        turnPill.style.display = "inline-flex";
        buzzPill.style.display = "none";
        turnPill.textContent = `Turn: ${state.teams[state.turn.teamIndex]?.name || "Team"}`;
      } else {
        turnPill.style.display = "none";
        buzzPill.style.display = "inline-flex";
        buzzPill.textContent = state.buzzer.locked
          ? `Buzz: ${state.buzzer.winner?.name || "Locked"}`
          : "Buzz: Open";
      }

      if(!state.active){
        active.textContent = "Waiting for the host to pick a clue…";
        buzzBtn.style.display = "none";
        hint.textContent = "";
        return;
      }

      const { catIdx, rowIdx, showing } = state.active;
      const cat = state.game.categories[catIdx];
      const clue = cat.clues[rowIdx];

      active.textContent =
        showing === "q"
          ? `LIVE CLUE\n${cat.name} — $${clue.value}\n\n${clue.q}`
          : `ANSWER\n\n${clue.a}`;

      if(state.mode === "BUZZER" && showing === "q"){
        buzzBtn.style.display = state.buzzer.locked ? "none" : "block";
        hint.textContent = state.buzzer.locked ? "Someone already buzzed in." : "Tap BUZZ to ring in!";
      } else if(state.mode === "TURNS" && showing === "q"){
        buzzBtn.style.display = "none";
        hint.textContent = "Take Turns mode: only the active team answers.";
      } else {
        buzzBtn.style.display = "none";
        hint.textContent = "";
      }
    }
  </script>
</body>
</html>
